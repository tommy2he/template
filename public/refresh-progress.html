<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>çŠ¶æ€åˆ·æ–°è¿›åº¦ç›‘æ§</title>
    <style>
      :root {
        --primary-color: #1890ff;
        --secondary-color: #52c41a;
        --danger-color: #ff4d4f;
        --warning-color: #faad14;
        --bg-color: #f5f5f5;
        --card-bg: #ffffff;
        --text-color: #262626;
        --border-color: #d9d9d9;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        background-color: var(--bg-color);
        color: var(--text-color);
      }

      .header {
        background: linear-gradient(135deg, var(--primary-color), #40a9ff);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0;
        font-size: 2em;
      }

      .header p {
        margin: 10px 0 0;
        opacity: 0.9;
      }

      .back-link {
        display: inline-block;
        margin-top: 15px;
        color: white;
        text-decoration: none;
        font-weight: bold;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .task-info {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .task-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .info-item {
        padding: 10px;
        background: var(--bg-color);
        border-radius: 4px;
      }

      .info-label {
        font-weight: bold;
        color: #8c8c8c;
        font-size: 0.9em;
      }

      .info-value {
        font-size: 1.1em;
        margin-top: 5px;
      }

      .progress-container {
        background: var(--card-bg);
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .progress-bar {
        width: 100%;
        height: 30px;
        background: var(--bg-color);
        border-radius: 15px;
        margin: 20px 0;
        overflow: hidden;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), #40a9ff);
        border-radius: 15px;
        width: 0%;
        transition: width 0.5s ease-in-out;
        position: relative;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        color: var(--text-color);
        z-index: 1;
      }

      .stats-container {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .stat-item {
        padding: 15px;
        text-align: center;
        border-radius: 8px;
      }

      .stat-item.online {
        background: rgba(82, 196, 26, 0.1);
        border-left: 4px solid var(--secondary-color);
      }

      .stat-item.offline {
        background: rgba(255, 77, 79, 0.1);
        border-left: 4px solid var(--danger-color);
      }

      .stat-item.total {
        background: rgba(24, 144, 255, 0.1);
        border-left: 4px solid var(--primary-color);
      }

      .stat-item.time {
        background: rgba(250, 173, 20, 0.1);
        border-left: 4px solid var(--warning-color);
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
      }

      .stat-label {
        color: #8c8c8c;
        font-size: 0.9em;
      }

      .actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background: #40a9ff;
      }

      .btn-secondary {
        background: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: #e6f7ff;
        border-color: var(--primary-color);
      }

      .btn-danger {
        background: var(--danger-color);
        color: white;
      }

      .btn-danger:hover {
        background: #ff7875;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
        margin-left: 10px;
      }

      .status-pending {
        background: #d9d9d9;
        color: #595959;
      }
      .status-running {
        background: #e6f7ff;
        color: #0050b3;
      }
      .status-completed {
        background: #f6ffed;
        color: #237804;
      }
      .status-failed {
        background: #fff1f0;
        color: #a8071a;
      }
      .status-cancelled {
        background: #fff7e6;
        color: #ad6800;
      }

      .log-container {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
      }

      .log-entry {
        padding: 5px 0;
        border-bottom: 1px solid var(--border-color);
      }

      .log-time {
        color: #8c8c8c;
        margin-right: 10px;
      }

      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ”„ CPEçŠ¶æ€åˆ·æ–°è¿›åº¦ç›‘æ§</h1>
      <p>å®æ—¶ç›‘æ§çŠ¶æ€åˆ·æ–°ä»»åŠ¡çš„æ‰§è¡Œè¿›åº¦</p>
      <a href="/" class="back-link">â† è¿”å›ä¸»æ§åˆ¶é¢æ¿</a>
    </div>

    <div class="task-info">
      <h2>ä»»åŠ¡ä¿¡æ¯</h2>
      <div class="task-info-grid">
        <div class="info-item">
          <div class="info-label">ä»»åŠ¡ID</div>
          <div class="info-value" id="task-id">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">æ¨¡å¼</div>
          <div class="info-value" id="task-mode">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">çŠ¶æ€</div>
          <div class="info-value" id="task-status">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¼€å§‹æ—¶é—´</div>
          <div class="info-value" id="task-started">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">å®Œæˆæ—¶é—´</div>
          <div class="info-value" id="task-completed">--</div>
        </div>
        <div class="info-item">
          <div class="info-label">æ“ä½œå‘˜</div>
          <div class="info-value" id="task-operator">--</div>
        </div>
      </div>
    </div>

    <div class="progress-container">
      <h2>åˆ·æ–°è¿›åº¦</h2>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
        <div class="progress-text" id="progress-text">0%</div>
      </div>
      <div id="progress-details">
        <p>æ­£åœ¨åˆå§‹åŒ–ä»»åŠ¡...</p>
      </div>
    </div>

    <div class="stats-container">
      <h2>ç»Ÿè®¡ä¿¡æ¯</h2>
      <div class="stats-grid">
        <div class="stat-item total">
          <div class="stat-label">æ€»è®¾å¤‡æ•°</div>
          <div class="stat-value" id="total-devices">0</div>
        </div>
        <div class="stat-item online">
          <div class="stat-label">åœ¨çº¿è®¾å¤‡</div>
          <div class="stat-value" id="online-devices">0</div>
        </div>
        <div class="stat-item offline">
          <div class="stat-label">ç¦»çº¿è®¾å¤‡</div>
          <div class="stat-value" id="offline-devices">0</div>
        </div>
        <div class="stat-item time">
          <div class="stat-label">é¢„ä¼°å‰©ä½™æ—¶é—´</div>
          <div class="stat-value" id="estimated-time">--</div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button
        onclick="refreshProgress()"
        class="btn btn-secondary"
        id="refresh-btn"
      >
        ğŸ”„ åˆ·æ–°è¿›åº¦
      </button>
      <button onclick="cancelTask()" class="btn btn-danger" id="cancel-btn">
        ğŸ›‘ å–æ¶ˆä»»åŠ¡
      </button>
      <button onclick="viewInBackground()" class="btn btn-secondary">
        â¸ï¸ åœ¨åå°ç»§ç»­
      </button>
    </div>

    <div class="log-container" id="log-container">
      <h3>ä»»åŠ¡æ—¥å¿—</h3>
      <div id="log-entries">
        <div class="log-entry">
          <span class="log-time" id="current-time"></span>
          <span>é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ç›‘æ§ä»»åŠ¡è¿›åº¦...</span>
        </div>
      </div>
    </div>

    <script>
      // è·å–URLå‚æ•°
      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          taskId: params.get('taskId'),
        };
      }

      // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
      function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now
          .toTimeString()
          .split(' ')[0];
      }

      // æ·»åŠ æ—¥å¿—æ¡ç›®
      function addLogEntry(message) {
        const now = new Date();
        const timeStr = now.toTimeString().split(' ')[0];

        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
                <span class="log-time">${timeStr}</span>
                <span>${message}</span>
            `;

        document.getElementById('log-entries').appendChild(logEntry);
        // æ»šåŠ¨åˆ°åº•éƒ¨
        const container = document.getElementById('log-container');
        container.scrollTop = container.scrollHeight;
      }

      // æ ¼å¼åŒ–æ—¶é—´
      function formatTime(dateString) {
        if (!dateString) return '--';
        const date = new Date(dateString);
        return date.toLocaleString('zh-CN');
      }

      // æ ¼å¼åŒ–æ—¶é•¿ï¼ˆç§’è½¬ä¸ºå¯è¯»æ ¼å¼ï¼‰
      function formatDuration(seconds) {
        if (!seconds || seconds <= 0) return '--';

        if (seconds < 60) {
          return `${seconds}ç§’`;
        } else if (seconds < 3600) {
          const minutes = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${minutes}åˆ†${secs}ç§’`;
        } else {
          const hours = Math.floor(seconds / 3600);
          const minutes = Math.floor((seconds % 3600) / 60);
          return `${hours}å°æ—¶${minutes}åˆ†`;
        }
      }

      // è·å–ä»»åŠ¡è¿›åº¦
      async function fetchTaskProgress() {
        const { taskId } = getUrlParams();
        if (!taskId) {
          addLogEntry('é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»åŠ¡IDå‚æ•°');
          return null;
        }

        try {
          const response = await fetch(`/api/admin/refresh-tasks/${taskId}`);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const result = await response.json();

          if (result.success) {
            return result.data;
          } else {
            throw new Error(result.error || 'è·å–ä»»åŠ¡ä¿¡æ¯å¤±è´¥');
          }
        } catch (error) {
          addLogEntry(`è·å–ä»»åŠ¡è¿›åº¦å¤±è´¥: ${error.message}`);
          return null;
        }
      }

      // æ›´æ–°UIæ˜¾ç¤º
      function updateUI(task) {
        if (!task) return;

        // æ›´æ–°ä»»åŠ¡ä¿¡æ¯
        document.getElementById('task-id').textContent = task.taskId;
        document.getElementById('task-mode').textContent =
          task.mode === 'force' ? 'å¼ºåˆ¶æ¨¡å¼' : 'æ™®é€šæ¨¡å¼';
        document.getElementById('task-started').textContent = formatTime(
          task.startedAt,
        );
        document.getElementById('task-completed').textContent = formatTime(
          task.completedAt,
        );
        document.getElementById('task-operator').textContent =
          task.operator || 'ç³»ç»Ÿ';

        // æ›´æ–°çŠ¶æ€ï¼ˆå¸¦çŠ¶æ€å¾½ç« ï¼‰
        const statusMap = {
          pending: { text: 'ç­‰å¾…ä¸­', class: 'status-pending' },
          running: { text: 'è¿è¡Œä¸­', class: 'status-running' },
          completed: { text: 'å·²å®Œæˆ', class: 'status-completed' },
          failed: { text: 'å·²å¤±è´¥', class: 'status-failed' },
          cancelled: { text: 'å·²å–æ¶ˆ', class: 'status-cancelled' },
        };

        const statusInfo = statusMap[task.status] || {
          text: task.status,
          class: '',
        };
        document.getElementById('task-status').innerHTML = `
                ${statusInfo.text}
                <span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>
            `;

        // æ›´æ–°è¿›åº¦æ¡
        const progress = task.progress || 0;
        document.getElementById('progress-fill').style.width = `${progress}%`;
        document.getElementById('progress-text').textContent = `${progress}%`;

        // æ›´æ–°è¿›åº¦è¯¦æƒ…
        const progressDetails = document.getElementById('progress-details');
        if (task.status === 'running') {
          const estimatedTime = formatDuration(task.estimatedTimeRemaining);
          progressDetails.innerHTML = `
                    <p>å·²å¤„ç†: ${task.processedDevices || 0} / ${task.totalDevices || 0} ä¸ªè®¾å¤‡</p>
                    <p>é¢„ä¼°å‰©ä½™æ—¶é—´: ${estimatedTime}</p>
                    <p>å¤„ç†é€Ÿåº¦: ${task.totalDevices > 0 ? Math.round((task.processedDevices / (Date.now() - new Date(task.startedAt).getTime())) * 1000 * 60) : 0} è®¾å¤‡/åˆ†é’Ÿ</p>
                `;
        } else if (task.status === 'completed') {
          progressDetails.innerHTML = `
                    <p>âœ… ä»»åŠ¡å·²å®Œæˆï¼</p>
                    <p>æ€»è®¾å¤‡: ${task.totalDevices || 0}ï¼Œåœ¨çº¿: ${task.onlineCount || 0}ï¼Œç¦»çº¿: ${task.offlineCount || 0}</p>
                    <p>æ€»è€—æ—¶: ${
                      task.completedAt && task.startedAt
                        ? Math.round(
                            (new Date(task.completedAt).getTime() -
                              new Date(task.startedAt).getTime()) /
                              1000,
                          )
                        : 0
                    } ç§’</p>
                `;
        } else if (task.status === 'failed') {
          progressDetails.innerHTML = `
                    <p>âŒ ä»»åŠ¡å¤±è´¥: ${task.error || 'æœªçŸ¥é”™è¯¯'}</p>
                    ${task.errorDetails ? `<p><small>${task.errorDetails}</small></p>` : ''}
                `;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        document.getElementById('total-devices').textContent =
          task.totalDevices || 0;
        document.getElementById('online-devices').textContent =
          task.onlineCount || 0;
        document.getElementById('offline-devices').textContent =
          task.offlineCount || 0;

        const estimatedTime =
          task.estimatedTimeRemaining > 0
            ? formatDuration(task.estimatedTimeRemaining)
            : '--';
        document.getElementById('estimated-time').textContent = estimatedTime;

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        const cancelBtn = document.getElementById('cancel-btn');
        const refreshBtn = document.getElementById('refresh-btn');

        if (task.status === 'running') {
          cancelBtn.disabled = false;
          cancelBtn.innerHTML = 'ğŸ›‘ å–æ¶ˆä»»åŠ¡';
          refreshBtn.innerHTML = 'ğŸ”„ è‡ªåŠ¨åˆ·æ–°ä¸­...';
          refreshBtn.disabled = true;
        } else {
          cancelBtn.disabled = true;
          cancelBtn.innerHTML = 'ä»»åŠ¡å·²å®Œæˆ';
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = 'ğŸ” é‡æ–°åŠ è½½';

          // å¦‚æœæ˜¯å®ŒæˆçŠ¶æ€ï¼Œ5ç§’åè‡ªåŠ¨è·³è½¬
          if (task.status === 'completed') {
            setTimeout(() => {
              addLogEntry('ä»»åŠ¡å®Œæˆï¼Œ5ç§’åè‡ªåŠ¨è·³è½¬å›ä¸»é¡µé¢...');
            }, 1000);

            setTimeout(() => {
              window.location.href = '/';
            }, 5000);
          }
        }
      }

      // å–æ¶ˆä»»åŠ¡
      async function cancelTask() {
        const { taskId } = getUrlParams();
        if (!taskId) return;

        if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿå·²ç»å¤„ç†çš„éƒ¨åˆ†å°†ä¿æŒå½“å‰çŠ¶æ€ã€‚')) {
          return;
        }

        addLogEntry('æ­£åœ¨å–æ¶ˆä»»åŠ¡...');

        try {
          const response = await fetch(
            `/api/admin/refresh-tasks/${taskId}/cancel`,
            {
              method: 'POST',
            },
          );
          const result = await response.json();

          if (result.success) {
            addLogEntry('ä»»åŠ¡å·²æˆåŠŸå–æ¶ˆ');
            // åˆ·æ–°æ˜¾ç¤º
            setTimeout(fetchAndUpdateProgress, 1000);
          } else {
            addLogEntry(`å–æ¶ˆä»»åŠ¡å¤±è´¥: ${result.error}`);
          }
        } catch (error) {
          addLogEntry(`å–æ¶ˆä»»åŠ¡è¯·æ±‚å¤±è´¥: ${error.message}`);
        }
      }

      // æ‰‹åŠ¨åˆ·æ–°è¿›åº¦
      async function refreshProgress() {
        addLogEntry('æ‰‹åŠ¨åˆ·æ–°è¿›åº¦...');
        await fetchAndUpdateProgress();
      }

      // åœ¨åå°ç»§ç»­ï¼ˆè¿”å›ä¸»é¡µï¼‰
      function viewInBackground() {
        addLogEntry('ä»»åŠ¡å°†åœ¨åå°ç»§ç»­æ‰§è¡Œï¼Œè¿”å›ä¸»é¡µé¢...');
        window.location.href = '/';
      }

      // è·å–å¹¶æ›´æ–°è¿›åº¦
      async function fetchAndUpdateProgress() {
        const task = await fetchTaskProgress();
        updateUI(task);
        updateCurrentTime();

        if (task && task.status === 'running') {
          // å¦‚æœä»»åŠ¡ä»åœ¨è¿è¡Œï¼Œ3ç§’åè‡ªåŠ¨åˆ·æ–°
          setTimeout(fetchAndUpdateProgress, 3000);
        }
      }

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function () {
        const { taskId } = getUrlParams();

        if (!taskId) {
          addLogEntry('é”™è¯¯ï¼šURLä¸­æœªåŒ…å«ä»»åŠ¡IDå‚æ•°');
          document.body.innerHTML = `
                    <div class="header">
                        <h1>âŒ é”™è¯¯</h1>
                        <p>æœªæ‰¾åˆ°ä»»åŠ¡IDå‚æ•°</p>
                        <a href="/" class="back-link">â† è¿”å›ä¸»æ§åˆ¶é¢æ¿</a>
                    </div>
                    <div class="task-info">
                        <p>è¯·ä»ä¸»æ§åˆ¶é¢æ¿çš„"CPEçŠ¶æ€åˆ·æ–°"æŒ‰é’®å¯åŠ¨åˆ·æ–°ä»»åŠ¡ã€‚</p>
                    </div>
                `;
          return;
        }

        addLogEntry(`å¼€å§‹ç›‘æ§ä»»åŠ¡: ${taskId}`);
        updateCurrentTime();

        // åˆå§‹è·å–è¿›åº¦
        fetchAndUpdateProgress();

        // æ¯30ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´æ˜¾ç¤º
        setInterval(updateCurrentTime, 30000);
      });
    </script>
  </body>
</html>
