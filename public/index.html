<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ACSæœåŠ¡å™¨ - Koa Template App</title>
    <style>
      :root {
        --primary-color: #1890ff;
        --secondary-color: #52c41a;
        --danger-color: #ff4d4f;
        --warning-color: #faad14;
        --bg-color: #f5f5f5;
        --card-bg: #ffffff;
        --text-color: #262626;
        --border-color: #d9d9d9;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        background-color: var(--bg-color);
        color: var(--text-color);
      }

      .header {
        background: linear-gradient(135deg, var(--primary-color), #40a9ff);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0;
        font-size: 2.5em;
      }

      .header p {
        margin: 10px 0 0;
        opacity: 0.9;
      }

      .status-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .status-item {
        flex: 1;
        background: var(--card-bg);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s;
      }

      .status-item:hover {
        transform: translateY(-2px);
      }

      .status-item .count {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
      }

      .status-item.online {
        border-left: 4px solid var(--secondary-color);
      }
      .status-item.offline {
        border-left: 4px solid var(--danger-color);
      }
      .status-item.total {
        border-left: 4px solid var(--primary-color);
      }
      .status-item.heartbeats {
        border-left: 4px solid var(--warning-color);
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        margin-top: 0;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
        color: var(--primary-color);
      }

      .link-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .link-list li {
        margin: 12px 0;
        padding: 12px 15px;
        background: var(--bg-color);
        border-radius: 6px;
        transition: all 0.3s;
      }

      .link-list li:hover {
        background: #e6f7ff;
        transform: translateX(5px);
      }

      .link-list a {
        text-decoration: none;
        color: var(--text-color);
        display: block;
        font-weight: 500;
      }

      .link-list a:hover {
        color: var(--primary-color);
      }

      .link-type {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        margin-right: 10px;
        color: white;
      }

      .get {
        background: var(--secondary-color);
      }
      .post {
        background: var(--primary-color);
      }
      .put {
        background: var(--warning-color);
      }
      .delete {
        background: var(--danger-color);
      }
      .patch {
        background: #722ed1;
      }

      .external-link::after {
        content: ' â†—';
        font-size: 0.9em;
        opacity: 0.7;
      }

      .footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        text-align: center;
        color: #8c8c8c;
        font-size: 0.9em;
      }

      .quick-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background: #40a9ff;
        color: white;
      }

      .btn-secondary {
        background: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: #e6f7ff;
        border-color: var(--primary-color);
      }

      .system-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
        font-size: 0.9em;
      }

      .info-item {
        padding: 10px;
        background: var(--bg-color);
        border-radius: 4px;
      }

      .info-label {
        font-weight: bold;
        color: #8c8c8c;
      }
      /* çŠ¶æ€åˆ·æ–°ç›¸å…³æ ·å¼ */
      .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .dialog-content {
        background: white;
        width: 500px;
        max-width: 90%;
        max-height: 80vh;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .dialog-body {
        padding: 20px;
        overflow-y: auto;
        flex-grow: 1;
      }

      .dialog-footer {
        padding: 15px 20px;
        background: #f5f5f5;
        border-top: 1px solid #ddd;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .refresh-mode-options {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .mode-option {
        border: 2px solid #e8e8e8;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }

      .mode-option:hover {
        border-color: #1890ff;
        background: #f0f7ff;
      }

      .mode-option.selected {
        border-color: #1890ff;
        background: #e6f7ff;
      }

      .mode-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .mode-title {
        font-weight: bold;
        font-size: 1.1em;
        margin-left: 10px;
        flex-grow: 1;
      }

      .mode-badge {
        background: #52c41a;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .mode-badge.warning {
        background: #faad14;
      }

      .mode-description {
        color: #666;
        font-size: 0.9em;
        line-height: 1.4;
        margin: 10px 0;
      }

      .mode-details {
        background: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        font-size: 0.85em;
      }

      .status-available {
        color: #52c41a;
        font-weight: bold;
      }

      .status-unavailable {
        color: #ff4d4f;
        font-weight: bold;
      }

      .warning-text {
        color: #faad14;
        font-weight: bold;
      }

      .refresh-summary {
        background: #f0f7ff;
        border: 1px solid #91d5ff;
        border-radius: 6px;
        padding: 15px;
        margin-top: 20px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin: 10px 0;
      }

      .summary-item {
        display: flex;
        flex-direction: column;
      }

      .summary-label {
        font-size: 0.9em;
        color: #666;
      }

      .summary-value {
        font-weight: bold;
        color: #1890ff;
      }

      .summary-note {
        font-size: 0.85em;
        color: #666;
        margin-top: 10px;
        font-style: italic;
      }

      /* åˆ·æ–°å†å²ç›¸å…³æ ·å¼ */
      .history-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .filter-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .filter-controls select,
      .filter-controls input {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
      }

      .history-stats {
        display: flex;
        gap: 15px;
      }

      .stat-item {
        font-size: 0.9em;
        color: #666;
      }

      .stat-item span {
        font-weight: bold;
        color: #1890ff;
      }

      .history-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .history-item {
        background: white;
        border: 1px solid #eee;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s;
      }

      .history-item:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .history-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .history-item-id {
        font-family: monospace;
        font-size: 0.9em;
        color: #666;
      }

      .history-item-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .status-completed {
        background: #f6ffed;
        color: #52c41a;
        border: 1px solid #b7eb8f;
      }

      .status-running {
        background: #e6f7ff;
        color: #1890ff;
        border: 1px solid #91d5ff;
      }

      .status-failed {
        background: #fff1f0;
        color: #ff4d4f;
        border: 1px solid #ffa39e;
      }

      .status-cancelled {
        background: #fff7e6;
        color: #faad14;
        border: 1px solid #ffd591;
      }

      .history-item-details {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        font-size: 0.85em;
        margin-top: 10px;
      }

      .history-detail-item {
        display: flex;
        flex-direction: column;
      }

      .history-detail-label {
        color: #999;
        margin-bottom: 2px;
      }

      .history-detail-value {
        font-weight: bold;
      }

      .loading-spinner {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
        margin-top: 10px;
      }

      .btn-view {
        padding: 4px 8px;
        background: #1890ff;
        color: white;
        border: none;
        border-radius: 3px;
        font-size: 0.8em;
        cursor: pointer;
      }

      .btn-view:hover {
        background: #40a9ff;
      }

      .btn-warning {
        background: #faad14;
        color: white;
      }

      .btn-warning:hover {
        background: #ffc53d;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ“¡ ACS æœåŠ¡å™¨æ§åˆ¶é¢æ¿</h1>
      <p>Koaæ¨¡æ¿åº”ç”¨ - TR-069 ACSä»¿çœŸç³»ç»Ÿ v2.0</p>
    </div>

    <div class="status-bar">
      <div class="status-item total">
        <div class="label">æ€»è®¾å¤‡æ•°</div>
        <div class="count" id="total-devices">--</div>
        <div>CPEæ€»æ•°</div>
      </div>
      <div class="status-item online">
        <div class="label">åœ¨çº¿è®¾å¤‡</div>
        <div class="count" id="online-devices">--</div>
        <div>å½“å‰åœ¨çº¿</div>
      </div>
      <div class="status-item offline">
        <div class="label">ç¦»çº¿è®¾å¤‡</div>
        <div class="count" id="offline-devices">--</div>
        <div>å½“å‰ç¦»çº¿</div>
      </div>
      <div class="status-item heartbeats">
        <div class="label">å¿ƒè·³ç»Ÿè®¡</div>
        <div class="count" id="heartbeat-count">--</div>
        <div>æ€»å¿ƒè·³æ•°</div>
      </div>
    </div>

    <div class="container">
      <div class="card">
        <h2>ğŸ”§ ç³»ç»Ÿç®¡ç†</h2>
        <ul class="link-list">
          <li>
            <a href="/ui.html" class="external-link">
              <span class="link-type get">ğŸ“Š</span>
              ACSç®¡ç†å‘˜ç•Œé¢
            </a>
          </li>
          <li>
            <a
              href="http://localhost:8081"
              target="_blank"
              class="external-link"
            >
              <span class="link-type get">ğŸ—„ï¸</span>
              æ•°æ®åº“ç®¡ç†ç•Œé¢
            </a>
            <span style="color: #8c8c8c; font-size: 0.9em">(ç«¯å£: 8081)</span>
          </li>
          <li>
            <a href="/cpe/monitor" target="_blank" class="external-link">
              <span class="link-type get">ğŸ“±</span>
              CPEç›‘æ§é¢æ¿
            </a>
          </li>
          <li>
            <a href="/api-docs" target="_blank" class="external-link">
              <span class="link-type get">ğŸ“–</span>
              APIæ–‡æ¡£ (Swagger UI)
            </a>
          </li>
          <li>
            <a href="/swagger.json" target="_blank" class="external-link">
              <span class="link-type get">ğŸ“„</span>
              OpenAPIè§„èŒƒ (JSON)
            </a>
          </li>
        </ul>

        <div class="quick-actions">
          <a href="/api/health" class="btn btn-secondary">ç³»ç»Ÿå¥åº·æ£€æŸ¥</a>
          <a href="/api/performance" class="btn btn-secondary">æ€§èƒ½æŒ‡æ ‡</a>
          <button onclick="refreshStatus()" class="btn btn-primary">
            åˆ·æ–°çŠ¶æ€
          </button>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“¡ CPEç®¡ç†API</h2>
        <ul class="link-list">
          <li>
            <a href="/api/cpes" target="_blank">
              <span class="link-type get">GET</span>
              è·å–æ‰€æœ‰CPEåˆ—è¡¨
            </a>
          </li>
          <li>
            <a href="/api/cpes?status=online" target="_blank">
              <span class="link-type get">GET</span>
              è·å–åœ¨çº¿CPE
            </a>
          </li>
          <li>
            <a href="/api/cpes?status=offline" target="_blank">
              <span class="link-type get">GET</span>
              è·å–ç¦»çº¿CPE
            </a>
          </li>
          <li>
            <a href="#" onclick="showWakeupDialog()">
              <span class="link-type post">POST</span>
              å”¤é†’CPE (éœ€è¦CPE ID)
            </a>
          </li>
          <li>
            <a href="#" onclick="showConfigDialog()">
              <span class="link-type post">POST</span>
              ä¸‹å‘é…ç½® (éœ€è¦CPE ID)
            </a>
          </li>
        </ul>

        <div class="quick-actions">
          <a href="/api/cpes/stats" class="btn btn-secondary">CPEç»Ÿè®¡</a>
          <button onclick="scanRoutes()" class="btn btn-secondary">
            æ‰«æAPI
          </button>
          <button onclick="showRefreshDialog()" class="btn btn-primary">
            ğŸ”„ CPEçŠ¶æ€åˆ·æ–°
          </button>
          <!-- æ–°å¢çš„æŸ¥çœ‹åˆ·æ–°å†å²æŒ‰é’® -->
          <button onclick="showRefreshHistory()" class="btn btn-secondary">
            ğŸ“œ åˆ·æ–°å†å²
          </button>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ”Œ è®¾å¤‡ç®¡ç†API</h2>
        <ul class="link-list">
          <li>
            <a href="/api/devices" target="_blank">
              <span class="link-type get">GET</span>
              è·å–è®¾å¤‡åˆ—è¡¨
            </a>
          </li>
          <li>
            <a href="/api/devices/stats" target="_blank">
              <span class="link-type get">GET</span>
              è®¾å¤‡ç»Ÿè®¡ä¿¡æ¯
            </a>
          </li>
          <li>
            <a href="/api/devices/search" target="_blank">
              <span class="link-type get">GET</span>
              æœç´¢è®¾å¤‡
            </a>
          </li>
          <li>
            <a href="#" onclick="showCreateDeviceDialog()">
              <span class="link-type post">POST</span>
              åˆ›å»ºè®¾å¤‡
            </a>
          </li>
        </ul>

        <div class="quick-actions">
          <a href="/api/devices?status=online" class="btn btn-secondary"
            >åœ¨çº¿è®¾å¤‡</a
          >
          <a href="/api/devices?status=offline" class="btn btn-secondary"
            >ç¦»çº¿è®¾å¤‡</a
          >
        </div>
      </div>

      <div class="card">
        <h2>âš™ï¸ ç³»ç»ŸAPI</h2>
        <ul class="link-list">
          <li>
            <a href="/api" target="_blank">
              <span class="link-type get">GET</span>
              APIæ ¹ç›®å½•
            </a>
          </li>
          <li>
            <a href="/api/health" target="_blank">
              <span class="link-type get">GET</span>
              å¥åº·æ£€æŸ¥
            </a>
          </li>
          <li>
            <a href="/api/status" target="_blank">
              <span class="link-type get">GET</span>
              åº”ç”¨çŠ¶æ€
            </a>
          </li>
          <li>
            <a href="/api/echo/test-message" target="_blank">
              <span class="link-type get">GET</span>
              æ¶ˆæ¯å›æ˜¾
            </a>
          </li>
          <li>
            <a href="/api/performance" target="_blank">
              <span class="link-type get">GET</span>
              æ€§èƒ½æŒ‡æ ‡
            </a>
          </li>
          <li>
            <a href="/api/performance/health" target="_blank">
              <span class="link-type get">GET</span>
              è¯¦ç»†å¥åº·æ£€æŸ¥
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="card" style="grid-column: 1 / -1; margin-top: 20px">
      <h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
      <div class="system-info">
        <div class="info-item">
          <div class="info-label">æœåŠ¡å™¨åœ°å€</div>
          <div>http://localhost:3000</div>
        </div>
        <div class="info-item">
          <div class="info-label">WebSocketåœ°å€</div>
          <div>ws://localhost:7547</div>
        </div>
        <div class="info-item">
          <div class="info-label">UDPå”¤é†’ç«¯å£</div>
          <div>7548</div>
        </div>
        <div class="info-item">
          <div class="info-label">ç¯å¢ƒæ¨¡å¼</div>
          <div id="env-mode">æ£€æµ‹ä¸­...</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¯åŠ¨æ—¶é—´</div>
          <div id="uptime">--</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>Â© 2023 Koa Template App - ACSä»¿çœŸç³»ç»Ÿ v2.0</p>
      <p>
        Node.js <span id="node-version"></span> | æœ€åæ›´æ–°:
        <span id="last-update"></span>
      </p>
    </div>

    <!-- ç®€å•å¯¹è¯æ¡† -->
    <div
      id="dialog"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      "
    >
      <div
        style="
          background: white;
          width: 400px;
          margin: 100px auto;
          padding: 20px;
          border-radius: 8px;
        "
      >
        <h3 id="dialog-title"></h3>
        <input
          type="text"
          id="dialog-input"
          style="width: 100%; padding: 8px; margin: 10px 0"
          placeholder="è¾“å…¥CPE ID"
        />
        <div style="text-align: right">
          <button
            onclick="closeDialog()"
            style="padding: 8px 16px; margin-right: 10px"
          >
            å–æ¶ˆ
          </button>
          <button
            onclick="submitDialog()"
            style="
              padding: 8px 16px;
              background: #1890ff;
              color: white;
              border: none;
            "
          >
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>
    <!-- çŠ¶æ€åˆ·æ–°å¯¹è¯æ¡†ï¼ˆæ·»åŠ åœ¨é¡µé¢åº•éƒ¨ï¼Œscriptæ ‡ç­¾ä¹‹å‰ï¼‰ -->
    <div
      id="status-refresh-dialog"
      class="dialog-overlay"
      style="display: none"
    >
      <div class="dialog-content">
        <h3 id="refresh-dialog-title">é€‰æ‹©åˆ·æ–°æ¨¡å¼</h3>

        <div class="dialog-body">
          <div class="refresh-mode-options">
            <div
              class="mode-option"
              onclick="selectRefreshMode('normal')"
              id="mode-normal"
            >
              <div class="mode-header">
                <input
                  type="radio"
                  name="refreshMode"
                  value="normal"
                  id="radio-normal"
                  checked
                />
                <label for="radio-normal" class="mode-title">Normalæ¨¡å¼</label>
                <span class="mode-badge">æ¨è</span>
              </div>
              <p class="mode-description">
                æ™ºèƒ½åˆ·æ–°æ¨¡å¼ï¼Œé¿å…é¢‘ç¹æ“ä½œ<br />
                <small>â€¢ 5åˆ†é’Ÿå†…åªå…è®¸åˆ·æ–°ä¸€æ¬¡</small><br />
                <small>â€¢ æ£€æŸ¥è®¾å¤‡çŠ¶æ€å˜åŒ–</small>
              </p>
              <div class="mode-details" id="normal-details">
                <p>ä¸Šæ¬¡åˆ·æ–°: <span id="last-normal-refresh">--</span></p>
                <p>
                  çŠ¶æ€:
                  <span id="normal-status" class="status-available"
                    >å¯åˆ·æ–°</span
                  >
                </p>
              </div>
            </div>

            <div
              class="mode-option"
              onclick="selectRefreshMode('force')"
              id="mode-force"
            >
              <div class="mode-header">
                <input
                  type="radio"
                  name="refreshMode"
                  value="force"
                  id="radio-force"
                />
                <label for="radio-force" class="mode-title">Forceæ¨¡å¼</label>
                <span class="mode-badge warning">å¼ºåˆ¶</span>
              </div>
              <p class="mode-description">
                å¼ºåˆ¶ç«‹å³åˆ·æ–°æ‰€æœ‰è®¾å¤‡<br />
                <small>â€¢ è·³è¿‡æ—¶é—´é™åˆ¶æ£€æŸ¥</small><br />
                <small>â€¢ é‡æ–°è®¡ç®—æ‰€æœ‰è®¾å¤‡çŠ¶æ€</small>
              </p>
              <div class="mode-details">
                <p class="warning-text">âš ï¸ æ­¤æ¨¡å¼å¯èƒ½ä¼šå½±å“ç³»ç»Ÿæ€§èƒ½</p>
              </div>
            </div>
          </div>

          <div
            class="refresh-summary"
            id="refresh-summary"
            style="display: none"
          >
            <h4>åˆ·æ–°æ‘˜è¦</h4>
            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-label">æ¨¡å¼:</span>
                <span id="summary-mode" class="summary-value">--</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">æ€»è®¾å¤‡:</span>
                <span id="summary-total" class="summary-value">--</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">é¢„è®¡æ—¶é—´:</span>
                <span id="summary-estimated" class="summary-value">--</span>
              </div>
            </div>
            <p class="summary-note">ç‚¹å‡»ç¡®è®¤åï¼Œç³»ç»Ÿå°†å¯åŠ¨åå°åˆ·æ–°ä»»åŠ¡ã€‚</p>
          </div>
        </div>

        <div class="dialog-footer">
          <button onclick="hideStatusRefreshDialog()" class="btn btn-secondary">
            å–æ¶ˆ
          </button>
          <button
            onclick="checkRefreshStatus()"
            class="btn btn-primary"
            id="check-refresh-btn"
          >
            æ£€æŸ¥çŠ¶æ€
          </button>
          <button
            onclick="confirmRefreshTask()"
            class="btn btn-success"
            id="confirm-refresh-btn"
            style="display: none"
          >
            å¼€å§‹åˆ·æ–°
          </button>
        </div>
      </div>
    </div>

    <!-- åˆ·æ–°å†å²å¯¹è¯æ¡† -->
    <div
      id="refresh-history-dialog"
      class="dialog-overlay"
      style="display: none"
    >
      <div class="dialog-content" style="max-width: 800px">
        <h3>åˆ·æ–°ä»»åŠ¡å†å²</h3>

        <div class="dialog-body">
          <div class="history-controls">
            <div class="filter-controls">
              <select
                id="history-filter-status"
                onchange="loadRefreshHistory()"
              >
                <option value="">æ‰€æœ‰çŠ¶æ€</option>
                <option value="completed">å·²å®Œæˆ</option>
                <option value="running">è¿è¡Œä¸­</option>
                <option value="failed">å¤±è´¥</option>
                <option value="cancelled">å·²å–æ¶ˆ</option>
              </select>
              <input
                type="date"
                id="history-filter-date"
                onchange="loadRefreshHistory()"
              />
              <button onclick="loadRefreshHistory()" class="btn btn-secondary">
                åˆ·æ–°
              </button>
            </div>

            <div class="history-stats">
              <span class="stat-item"
                >æ€»ä»»åŠ¡: <span id="history-total">0</span></span
              >
              <span class="stat-item"
                >æˆåŠŸ: <span id="history-success">0</span></span
              >
              <span class="stat-item"
                >å¤±è´¥: <span id="history-failed">0</span></span
              >
            </div>
          </div>

          <div class="history-list" id="history-list">
            <!-- ä»»åŠ¡å†å²å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            <div class="loading-spinner">åŠ è½½ä¸­...</div>
          </div>
        </div>

        <div class="dialog-footer">
          <button onclick="hideRefreshHistory()" class="btn btn-secondary">
            å…³é—­
          </button>
          <button onclick="clearOldRefreshHistory()" class="btn btn-warning">
            æ¸…ç†æ—§è®°å½•
          </button>
        </div>
      </div>
    </div>
    <script>
      // æ·»åŠ  CSP çŠ¶æ€æ£€æµ‹
      fetch(window.location.href, { method: 'HEAD' })
        .then((response) => {
          const cspHeader = response.headers.get('Content-Security-Policy');
          if (cspHeader) {
            document.getElementById('csp-status').textContent = 'CSPå·²é…ç½®';
            document.getElementById('csp-status').style.color = 'green';

            // æ£€æŸ¥æ˜¯å¦å…è®¸å†…è”è„šæœ¬
            if (cspHeader.includes("'unsafe-inline'")) {
              document.getElementById('csp-status').textContent +=
                'ï¼ˆå…è®¸å†…è”è„šæœ¬ï¼‰';
            }
          } else {
            document.getElementById('csp-status').textContent = 'æ— CSPé™åˆ¶';
            document.getElementById('csp-status').style.color = 'orange';
          }
        })
        .catch(() => {
          document.getElementById('csp-status').textContent = 'æ£€æµ‹å¤±è´¥';
          document.getElementById('csp-status').style.color = 'red';
        });
      // åˆå§‹åŒ–é¡µé¢ - ç§»é™¤ process ç›¸å…³ä»£ç 
      document.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸ“± ACSæ§åˆ¶é¢æ¿åˆå§‹åŒ–...');

        // ç§»é™¤ Node.js ç‰¹æœ‰çš„ä»£ç ï¼Œæ”¹ä¸ºå›ºå®šæ–‡æœ¬
        document.getElementById('node-version').textContent = 'æµè§ˆå™¨ä¸­ä¸å¯ç”¨';
        document.getElementById('last-update').textContent =
          new Date().toLocaleString();

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        loadSystemStatus();

        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
        setInterval(loadSystemStatus, 30000);
      });

      // åŠ è½½ç³»ç»ŸçŠ¶æ€
      // åŠ è½½ç³»ç»ŸçŠ¶æ€å‡½æ•°ä¿æŒä¸å˜ï¼ˆä½†éœ€è¦ç¡®ä¿æ²¡æœ‰processå¼•ç”¨ï¼‰
      async function loadSystemStatus() {
        console.log('ğŸ”„ åŠ è½½ç³»ç»ŸçŠ¶æ€...');
        try {
          // è·å–ç³»ç»Ÿå¥åº·ä¿¡æ¯
          const healthRes = await fetch('/api/health');
          if (healthRes.ok) {
            const healthData = await healthRes.json();
            document.getElementById('env-mode').textContent =
              healthData.environment || 'development';
            document.getElementById('uptime').textContent = formatUptime(
              healthData.uptime,
            );
          }

          // è·å–CPEç»Ÿè®¡
          const cpeRes = await fetch('/api/cpes/stats');
          if (cpeRes.ok) {
            const result = await cpeRes.json();
            console.log('ğŸ“Š CPEç»Ÿè®¡å“åº”:', result);

            if (result.success && result.data) {
              const data = result.data;
              document.getElementById('total-devices').textContent =
                data.total || 0;
              document.getElementById('online-devices').textContent =
                data.online || 0;
              document.getElementById('offline-devices').textContent =
                data.offline || 0;
              document.getElementById('heartbeat-count').textContent =
                data.totalHeartbeats || 0;
            }
          }
        } catch (error) {
          console.error('âŒ åŠ è½½çŠ¶æ€å¤±è´¥:', error);
        }
      }

      // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
      function formatUptime(seconds) {
        if (!seconds) return '--';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return `${hours}h ${minutes}m ${secs}s`;
      }

      // å¯¹è¯æ¡†ç›¸å…³
      let currentDialogAction = null;
      let dialogInput = null;

      function showWakeupDialog() {
        document.getElementById('dialog-title').textContent = 'å”¤é†’CPE';
        document.getElementById('dialog-input').placeholder =
          'è¾“å…¥è¦å”¤é†’çš„CPE ID (ä¾‹å¦‚: cpe-001)';
        dialogInput = document.getElementById('dialog-input');
        dialogInput.value = '';
        currentDialogAction = 'wakeup';
        document.getElementById('dialog').style.display = 'block';
      }

      function showConfigDialog() {
        document.getElementById('dialog-title').textContent = 'ä¸‹å‘é…ç½®åˆ°CPE';
        document.getElementById('dialog-input').placeholder =
          'è¾“å…¥ç›®æ ‡CPE ID (ä¾‹å¦‚: cpe-001)';
        dialogInput = document.getElementById('dialog-input');
        dialogInput.value = '';
        currentDialogAction = 'config';
        document.getElementById('dialog').style.display = 'block';
      }

      function showCreateDeviceDialog() {
        document.getElementById('dialog-title').textContent = 'åˆ›å»ºè®¾å¤‡';
        document.getElementById('dialog-input').placeholder =
          'è¾“å…¥è®¾å¤‡ID (ä¾‹å¦‚: device-001)';
        dialogInput = document.getElementById('dialog-input');
        dialogInput.value = '';
        currentDialogAction = 'createDevice';
        document.getElementById('dialog').style.display = 'block';
      }

      function closeDialog() {
        document.getElementById('dialog').style.display = 'none';
        currentDialogAction = null;
      }

      async function submitDialog() {
        const value = dialogInput.value.trim();
        if (!value) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ID');
          return;
        }

        try {
          if (currentDialogAction === 'wakeup') {
            const response = await fetch(`/api/cpes/${value}/wakeup`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
            });

            if (response.ok) {
              alert(`å”¤é†’æŒ‡ä»¤å·²å‘é€åˆ° ${value}`);
            } else {
              alert(`å”¤é†’å¤±è´¥: ${await response.text()}`);
            }
          } else if (currentDialogAction === 'config') {
            // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºæ›´å¤æ‚çš„é…ç½®ç•Œé¢
            const config = {
              timestamp: new Date().toISOString(),
              action: 'update',
              parameters: {
                'InternetGatewayDevice.ManagementServer.PeriodicInformInterval': 3600,
              },
            };

            const response = await fetch(`/api/cpes/${value}/configuration`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(config),
            });

            if (response.ok) {
              alert(`é…ç½®å·²ä¸‹å‘åˆ° ${value}`);
            } else {
              alert(`é…ç½®ä¸‹å‘å¤±è´¥: ${await response.text()}`);
            }
          } else if (currentDialogAction === 'createDevice') {
            const device = {
              deviceId: value,
              manufacturer: 'Generic',
              model: 'Device v1.0',
              ipAddress: '192.168.1.100',
              status: 'offline',
            };

            const response = await fetch('/api/devices', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(device),
            });

            if (response.ok) {
              alert(`è®¾å¤‡ ${value} åˆ›å»ºæˆåŠŸ`);
            } else {
              alert(`åˆ›å»ºè®¾å¤‡å¤±è´¥: ${await response.text()}`);
            }
          }
        } catch (error) {
          alert(`æ“ä½œå¤±è´¥: ${error.message}`);
        }

        closeDialog();
      }

      // åˆ·æ–°çŠ¶æ€
      function refreshStatus() {
        loadSystemStatus();
        alert('çŠ¶æ€å·²åˆ·æ–°');
      }

      // æ‰«æAPIè·¯ç”±ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
      async function scanRoutes() {
        const routes = [
          '/api',
          '/api/health',
          '/api/status',
          '/api/echo/test',
          '/api/devices',
          '/api/cpes',
          '/api/performance',
        ];

        let availableRoutes = [];

        for (const route of routes) {
          try {
            const response = await fetch(route);
            if (response.ok) {
              availableRoutes.push(`${route} âœ“`);
            }
          } catch (error) {
            availableRoutes.push(`${route} âœ—`);
          }
        }

        alert('APIè·¯ç”±æ‰«æå®Œæˆ:\n\n' + availableRoutes.join('\n'));
      }

      // çŠ¶æ€åˆ·æ–°ç›¸å…³å‡½æ•°
      // çŠ¶æ€åˆ·æ–°ç›¸å…³å‡½æ•°
      async function showRefreshDialog() {
        // åˆ›å»ºæ¨¡å¼é€‰æ‹©å¯¹è¯æ¡†
        const mode = await new Promise((resolve) => {
          const modeSelection = `
      <div id="mode-dialog" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        display: flex;
        align-items: center;
        justify-content: center;
      ">
        <div style="
          background: white;
          width: 400px;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        ">
          <h3 style="margin-top: 0;">é€‰æ‹©åˆ·æ–°æ¨¡å¼</h3>
          <p>âš ï¸ æ³¨æ„ï¼šåˆ·æ–°çŠ¶æ€ä¼šå½±å“æ‰€æœ‰CPEè®¾å¤‡</p>
          
          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 10px;">
              <input type="radio" name="refreshMode" value="normal" checked>
              Normalæ¨¡å¼ï¼ˆä»…åœ¨ä¸Šæ¬¡åˆ·æ–°5åˆ†é’Ÿåå¯ç”¨ï¼‰
            </label>
            <label style="display: block;">
              <input type="radio" name="refreshMode" value="force">
              Forceæ¨¡å¼ï¼ˆå¼ºåˆ¶ç«‹å³åˆ·æ–°ï¼‰
            </label>
          </div>
          
          <div style="text-align: right;">
            <button onclick="cancelModeDialog()" style="
              padding: 8px 16px;
              margin-right: 10px;
              background: #f5f5f5;
              border: 1px solid #d9d9d9;
              border-radius: 4px;
            ">
              å–æ¶ˆ
            </button>
            <button onclick="confirmModeDialog()" style="
              padding: 8px 16px;
              background: #1890ff;
              color: white;
              border: none;
              border-radius: 4px;
            ">
              å¼€å§‹åˆ·æ–°
            </button>
          </div>
        </div>
      </div>
    `;

          document.body.insertAdjacentHTML('beforeend', modeSelection);

          window.cancelModeDialog = () => {
            document.getElementById('mode-dialog')?.remove();
            resolve(null);
          };

          window.confirmModeDialog = () => {
            const selectedMode = document.querySelector(
              'input[name="refreshMode"]:checked',
            )?.value;
            document.getElementById('mode-dialog')?.remove();
            resolve(selectedMode);
          };
        });

        if (!mode) return;

        try {
          const response = await fetch('/api/admin/refresh-tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode, operator: 'admin' }),
          });

          const result = await response.json();

          if (response.ok) {
            alert(
              `åˆ·æ–°ä»»åŠ¡å·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ${result.data.taskId}\n\nå°†è·³è½¬åˆ°è¿›åº¦ç›‘æ§é¡µé¢ã€‚`,
            );
            // è·³è½¬åˆ°è¿›åº¦ç›‘æ§é¡µé¢
            window.location.href = `/refresh-progress.html?taskId=${result.data.taskId}`;
          } else {
            alert(`å¯åŠ¨å¤±è´¥: ${result.error}`);
          }
        } catch (error) {
          alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
        }
      }
      async function startRefreshTask(mode) {
        try {
          const response = await fetch('/api/admin/refresh-tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode, operator: 'admin' }),
          });

          const result = await response.json();

          if (response.ok) {
            alert(
              `åˆ·æ–°ä»»åŠ¡å·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ${result.data.taskId}\n\nå°†è·³è½¬åˆ°è¿›åº¦ç›‘æ§é¡µé¢ã€‚`,
            );
            // è·³è½¬åˆ°è¿›åº¦ç›‘æ§é¡µé¢
            window.location.href = `/refresh-progress.html?taskId=${result.data.taskId}`;
          } else {
            alert(`å¯åŠ¨å¤±è´¥: ${result.error}`);
          }
        } catch (error) {
          alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
        }
      }

      // ==================== çŠ¶æ€åˆ·æ–°ç›¸å…³åŠŸèƒ½ ====================

      let selectedRefreshMode = 'normal';
      let refreshTaskData = null;

      // æ˜¾ç¤ºçŠ¶æ€åˆ·æ–°å¯¹è¯æ¡†
      async function showStatusRefreshDialog() {
        selectedRefreshMode = 'normal';

        // é‡ç½®UI
        document.querySelectorAll('.mode-option').forEach((option) => {
          option.classList.remove('selected');
        });
        document.getElementById('mode-normal').classList.add('selected');

        // åŠ è½½æœ€è¿‘åˆ·æ–°çŠ¶æ€
        await loadLastRefreshStatus();

        // æ˜¾ç¤ºå¯¹è¯æ¡†
        document.getElementById('status-refresh-dialog').style.display = 'flex';

        // é‡ç½®æŒ‰é’®çŠ¶æ€
        document.getElementById('check-refresh-btn').style.display =
          'inline-block';
        document.getElementById('confirm-refresh-btn').style.display = 'none';
        document.getElementById('refresh-summary').style.display = 'none';
      }

      // éšè—çŠ¶æ€åˆ·æ–°å¯¹è¯æ¡†
      function hideStatusRefreshDialog() {
        document.getElementById('status-refresh-dialog').style.display = 'none';
        refreshTaskData = null;
      }

      // é€‰æ‹©åˆ·æ–°æ¨¡å¼
      function selectRefreshMode(mode) {
        selectedRefreshMode = mode;

        // æ›´æ–°UIé€‰æ‹©çŠ¶æ€
        document.querySelectorAll('.mode-option').forEach((option) => {
          option.classList.remove('selected');
        });
        document.getElementById('mode-' + mode).classList.add('selected');

        // æ›´æ–°é€‰ä¸­çš„radioæŒ‰é’®
        document.getElementById('radio-' + mode).checked = true;
      }

      // åŠ è½½æœ€è¿‘åˆ·æ–°çŠ¶æ€
      async function loadLastRefreshStatus() {
        try {
          const response = await fetch('/api/admin/refresh-tasks/check');
          const result = await response.json();

          if (result.success) {
            const data = result.data;

            if (data.lastRefreshTime) {
              const lastRefresh = new Date(data.lastRefreshTime);
              const now = new Date();
              const diffMinutes = Math.floor((now - lastRefresh) / 60000);

              document.getElementById('last-normal-refresh').textContent =
                `${diffMinutes} åˆ†é’Ÿå‰ (${lastRefresh.toLocaleString()})`;
            } else {
              document.getElementById('last-normal-refresh').textContent =
                'ä»æœªåˆ·æ–°';
            }

            if (data.canRefresh) {
              document.getElementById('normal-status').textContent = 'å¯åˆ·æ–°';
              document.getElementById('normal-status').className =
                'status-available';
            } else {
              document.getElementById('normal-status').textContent =
                data.message || 'ä¸å¯ç”¨';
              document.getElementById('normal-status').className =
                'status-unavailable';
            }
          }
        } catch (error) {
          console.error('åŠ è½½åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
          document.getElementById('last-normal-refresh').textContent =
            'åŠ è½½å¤±è´¥';
          document.getElementById('normal-status').textContent = 'æ£€æŸ¥å¤±è´¥';
          document.getElementById('normal-status').className =
            'status-unavailable';
        }
      }

      // æ£€æŸ¥åˆ·æ–°çŠ¶æ€
      async function checkRefreshStatus() {
        try {
          // è·å–è®¾å¤‡æ€»æ•°
          const statsResponse = await fetch('/api/cpes/stats');
          const statsResult = await statsResponse.json();

          const totalDevices = statsResult.success ? statsResult.data.total : 0;

          // æ ¹æ®æ¨¡å¼ä¼°ç®—æ—¶é—´
          let estimatedTime = 'æœªçŸ¥';
          if (totalDevices > 0) {
            const batchSize = 100; // å‡è®¾æ‰¹é‡å¤§å°ä¸º100
            const timePerBatch = 2; // æ¯æ‰¹é¢„è®¡2ç§’
            const batches = Math.ceil(totalDevices / batchSize);
            const totalSeconds = batches * timePerBatch;

            if (totalSeconds < 60) {
              estimatedTime = `${totalSeconds} ç§’`;
            } else {
              estimatedTime = `${Math.ceil(totalSeconds / 60)} åˆ†é’Ÿ`;
            }
          }

          // æ›´æ–°æ‘˜è¦ä¿¡æ¯
          document.getElementById('summary-mode').textContent =
            selectedRefreshMode === 'normal' ? 'æ™®é€šæ¨¡å¼' : 'å¼ºåˆ¶æ¨¡å¼';
          document.getElementById('summary-total').textContent = totalDevices;
          document.getElementById('summary-estimated').textContent =
            estimatedTime;

          // æ˜¾ç¤ºæ‘˜è¦å’Œç¡®è®¤æŒ‰é’®
          document.getElementById('refresh-summary').style.display = 'block';
          document.getElementById('check-refresh-btn').style.display = 'none';
          document.getElementById('confirm-refresh-btn').style.display =
            'inline-block';
        } catch (error) {
          console.error('æ£€æŸ¥åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
          alert(`æ£€æŸ¥å¤±è´¥: ${error.message}`);
        }
      }

      // ç¡®è®¤å¯åŠ¨åˆ·æ–°ä»»åŠ¡
      async function confirmRefreshTask() {
        try {
          const operator = 'ç®¡ç†å‘˜'; // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºè·å–å½“å‰ç™»å½•ç”¨æˆ·

          const response = await fetch('/api/admin/refresh-tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              mode: selectedRefreshMode,
              operator: operator,
            }),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            const task = result.data;

            // ä¿å­˜ä»»åŠ¡æ•°æ®
            refreshTaskData = task;

            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert(
              `åˆ·æ–°ä»»åŠ¡å·²å¯åŠ¨ï¼\nä»»åŠ¡ID: ${task.taskId}\n\nå°†è·³è½¬åˆ°è¿›åº¦ç›‘æ§é¡µé¢ã€‚`,
            );

            // å…³é—­å¯¹è¯æ¡†
            hideStatusRefreshDialog();

            // è·³è½¬åˆ°è¿›åº¦ç›‘æ§é¡µé¢
            window.location.href = `/refresh-progress.html?taskId=${task.taskId}`;
          } else {
            alert(`å¯åŠ¨å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
          }
        } catch (error) {
          console.error('å¯åŠ¨åˆ·æ–°ä»»åŠ¡å¤±è´¥:', error);
          alert(`è¯·æ±‚å¤±è´¥: ${error.message}`);
        }
      }

      // ==================== åˆ·æ–°å†å²ç›¸å…³åŠŸèƒ½ ====================

      // æ˜¾ç¤ºåˆ·æ–°å†å²å¯¹è¯æ¡†
      function showRefreshHistory() {
        document.getElementById('refresh-history-dialog').style.display =
          'flex';
        loadRefreshHistory();
      }

      // éšè—åˆ·æ–°å†å²å¯¹è¯æ¡†
      function hideRefreshHistory() {
        document.getElementById('refresh-history-dialog').style.display =
          'none';
      }

      // åŠ è½½åˆ·æ–°å†å²
      async function loadRefreshHistory() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '<div class="loading-spinner">åŠ è½½ä¸­...</div>';

        try {
          const statusFilter = document.getElementById(
            'history-filter-status',
          ).value;
          const dateFilter = document.getElementById(
            'history-filter-date',
          ).value;

          let url = '/api/admin/refresh-tasks?limit=20';
          if (statusFilter) {
            url += `&status=${statusFilter}`;
          }

          const response = await fetch(url);
          const result = await response.json();

          if (result.success) {
            const tasks = result.data.tasks || [];
            const stats = result.data.stats || {};

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('history-total').textContent =
              stats.total || 0;
            document.getElementById('history-success').textContent =
              stats.completed || 0;
            document.getElementById('history-failed').textContent =
              stats.failed || 0;

            // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
            if (tasks.length === 0) {
              historyList.innerHTML =
                '<div class="loading-spinner">æš‚æ— åˆ·æ–°ä»»åŠ¡è®°å½•</div>';
              return;
            }

            let html = '';
            tasks.forEach((task) => {
              const started = new Date(task.startedAt).toLocaleString();
              const completed = task.completedAt
                ? new Date(task.completedAt).toLocaleString()
                : '--';
              const duration = task.completedAt
                ? Math.round(
                    (new Date(task.completedAt) - new Date(task.startedAt)) /
                      1000,
                  )
                : '--';

              html += `
          <div class="history-item">
            <div class="history-item-header">
              <div>
                <strong>${task.mode === 'force' ? 'å¼ºåˆ¶æ¨¡å¼' : 'æ™®é€šæ¨¡å¼'}</strong>
                <span class="history-item-id">${task.taskId}</span>
              </div>
              <span class="history-item-status status-${task.status}">
                ${getStatusText(task.status)}
              </span>
            </div>
            
            <div class="history-item-details">
              <div class="history-detail-item">
                <span class="history-detail-label">å¼€å§‹æ—¶é—´</span>
                <span class="history-detail-value">${started}</span>
              </div>
              <div class="history-detail-item">
                <span class="history-detail-label">å®Œæˆæ—¶é—´</span>
                <span class="history-detail-value">${completed}</span>
              </div>
              <div class="history-detail-item">
                <span class="history-detail-label">è€—æ—¶</span>
                <span class="history-detail-value">${duration}ç§’</span>
              </div>
              <div class="history-detail-item">
                <span class="history-detail-label">è®¾å¤‡ç»Ÿè®¡</span>
                <span class="history-detail-value">${task.onlineCount || 0}åœ¨çº¿ / ${task.offlineCount || 0}ç¦»çº¿</span>
              </div>
            </div>
            
            <div class="action-buttons">
              <button onclick="viewTaskProgress('${task.taskId}')" class="btn btn-view">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
              ${
                task.status === 'running'
                  ? `
                <button onclick="cancelTaskFromHistory('${task.taskId}')" class="btn btn-view btn-warning">
                  å–æ¶ˆä»»åŠ¡
                </button>
              `
                  : ''
              }
            </div>
          </div>
        `;
            });

            historyList.innerHTML = html;
          } else {
            historyList.innerHTML = `<div class="loading-spinner">åŠ è½½å¤±è´¥: ${result.error}</div>`;
          }
        } catch (error) {
          console.error('åŠ è½½åˆ·æ–°å†å²å¤±è´¥:', error);
          historyList.innerHTML = `<div class="loading-spinner">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
      }

      // è·å–çŠ¶æ€æ–‡æœ¬
      function getStatusText(status) {
        const statusMap = {
          pending: 'ç­‰å¾…ä¸­',
          running: 'è¿è¡Œä¸­',
          completed: 'å·²å®Œæˆ',
          failed: 'å¤±è´¥',
          cancelled: 'å·²å–æ¶ˆ',
        };
        return statusMap[status] || status;
      }

      // æŸ¥çœ‹ä»»åŠ¡è¿›åº¦
      function viewTaskProgress(taskId) {
        window.location.href = `/refresh-progress.html?taskId=${taskId}`;
      }

      // ä»å†å²ä¸­å–æ¶ˆä»»åŠ¡
      async function cancelTaskFromHistory(taskId) {
        if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿå·²ç»å¤„ç†çš„éƒ¨åˆ†å°†ä¿æŒå½“å‰çŠ¶æ€ã€‚')) {
          return;
        }

        try {
          const response = await fetch(
            `/api/admin/refresh-tasks/${taskId}/cancel`,
            {
              method: 'POST',
            },
          );

          const result = await response.json();

          if (result.success) {
            alert('ä»»åŠ¡å·²å–æ¶ˆ');
            loadRefreshHistory(); // é‡æ–°åŠ è½½å†å²
          } else {
            alert(`å–æ¶ˆå¤±è´¥: ${result.error}`);
          }
        } catch (error) {
          alert(`å–æ¶ˆè¯·æ±‚å¤±è´¥: ${error.message}`);
        }
      }

      // æ¸…ç†æ—§åˆ·æ–°å†å²
      async function clearOldRefreshHistory() {
        if (!confirm('ç¡®å®šè¦æ¸…ç†30å¤©å‰çš„æ—§ä»»åŠ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
          return;
        }

        try {
          const response = await fetch('/api/admin/refresh-tasks/cleanup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ daysToKeep: 30 }),
          });

          const result = await response.json();

          if (result.success) {
            alert(`æ¸…ç†å®Œæˆ: ${result.message}`);
            loadRefreshHistory(); // é‡æ–°åŠ è½½å†å²
          } else {
            alert(`æ¸…ç†å¤±è´¥: ${result.error}`);
          }
        } catch (error) {
          alert(`æ¸…ç†è¯·æ±‚å¤±è´¥: ${error.message}`);
        }
      }

      // ==================== è¾…åŠ©å‡½æ•° ====================

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      document.addEventListener('DOMContentLoaded', function () {
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åˆå§‹åŒ–ä»£ç 
      });
    </script>
  </body>
</html>
