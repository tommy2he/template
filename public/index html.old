<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ACSæœåŠ¡å™¨ - Koa Template App</title>
    <style>
      :root {
        --primary-color: #1890ff;
        --secondary-color: #52c41a;
        --danger-color: #ff4d4f;
        --warning-color: #faad14;
        --bg-color: #f5f5f5;
        --card-bg: #ffffff;
        --text-color: #262626;
        --border-color: #d9d9d9;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          'Helvetica Neue', Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        background-color: var(--bg-color);
        color: var(--text-color);
      }

      .header {
        background: linear-gradient(135deg, var(--primary-color), #40a9ff);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .header h1 {
        margin: 0;
        font-size: 2.5em;
      }

      .header p {
        margin: 10px 0 0;
        opacity: 0.9;
      }

      .status-bar {
        display: flex;
        gap: 15px;
        margin-bottom: 30px;
      }

      .status-item {
        flex: 1;
        background: var(--card-bg);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s;
      }

      .status-item:hover {
        transform: translateY(-2px);
      }

      .status-item .count {
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
      }

      .status-item.online {
        border-left: 4px solid var(--secondary-color);
      }
      .status-item.offline {
        border-left: 4px solid var(--danger-color);
      }
      .status-item.total {
        border-left: 4px solid var(--primary-color);
      }
      .status-item.heartbeats {
        border-left: 4px solid var(--warning-color);
      }

      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      @media (max-width: 768px) {
        .container {
          grid-template-columns: 1fr;
        }
      }

      .card {
        background: var(--card-bg);
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        margin-top: 0;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-color);
        color: var(--primary-color);
      }

      .link-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .link-list li {
        margin: 12px 0;
        padding: 12px 15px;
        background: var(--bg-color);
        border-radius: 6px;
        transition: all 0.3s;
      }

      .link-list li:hover {
        background: #e6f7ff;
        transform: translateX(5px);
      }

      .link-list a {
        text-decoration: none;
        color: var(--text-color);
        display: block;
        font-weight: 500;
      }

      .link-list a:hover {
        color: var(--primary-color);
      }

      .link-type {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        margin-right: 10px;
        color: white;
      }

      .get {
        background: var(--secondary-color);
      }
      .post {
        background: var(--primary-color);
      }
      .put {
        background: var(--warning-color);
      }
      .delete {
        background: var(--danger-color);
      }
      .patch {
        background: #722ed1;
      }

      .external-link::after {
        content: ' â†—';
        font-size: 0.9em;
        opacity: 0.7;
      }

      .footer {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        text-align: center;
        color: #8c8c8c;
        font-size: 0.9em;
      }

      .quick-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background: #40a9ff;
        color: white;
      }

      .btn-secondary {
        background: var(--bg-color);
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: #e6f7ff;
        border-color: var(--primary-color);
      }

      .system-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
        font-size: 0.9em;
      }

      .info-item {
        padding: 10px;
        background: var(--bg-color);
        border-radius: 4px;
      }

      .info-label {
        font-weight: bold;
        color: #8c8c8c;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ğŸ“¡ ACS æœåŠ¡å™¨æ§åˆ¶é¢æ¿</h1>
      <p>Koaæ¨¡æ¿åº”ç”¨ - TR-069 ACSä»¿çœŸç³»ç»Ÿ v2.0</p>
    </div>

    <div class="status-bar">
      <div class="status-item total">
        <div class="label">æ€»è®¾å¤‡æ•°</div>
        <div class="count" id="total-devices">--</div>
        <div>CPEæ€»æ•°</div>
      </div>
      <div class="status-item online">
        <div class="label">åœ¨çº¿è®¾å¤‡</div>
        <div class="count" id="online-devices">--</div>
        <div>å½“å‰åœ¨çº¿</div>
      </div>
      <div class="status-item offline">
        <div class="label">ç¦»çº¿è®¾å¤‡</div>
        <div class="count" id="offline-devices">--</div>
        <div>å½“å‰ç¦»çº¿</div>
      </div>
      <div class="status-item heartbeats">
        <div class="label">å¿ƒè·³ç»Ÿè®¡</div>
        <div class="count" id="heartbeat-count">--</div>
        <div>æ€»å¿ƒè·³æ•°</div>
      </div>
    </div>

    <div class="container">
      <div class="card">
        <h2>ğŸ”§ ç³»ç»Ÿç®¡ç†</h2>
        <ul class="link-list">
          <li>
            <a href="/ui.html" class="external-link">
              <span class="link-type get">ğŸ“Š</span>
              ACSç®¡ç†å‘˜ç•Œé¢
            </a>
          </li>
          <li>
            <a
              href="http://localhost:8081"
              target="_blank"
              class="external-link"
            >
              <span class="link-type get">ğŸ—„ï¸</span>
              æ•°æ®åº“ç®¡ç†ç•Œé¢
            </a>
            <span style="color: #8c8c8c; font-size: 0.9em">(ç«¯å£: 8081)</span>
          </li>
          <li>
            <a href="/cpe/monitor" target="_blank" class="external-link">
              <span class="link-type get">ğŸ“±</span>
              CPEç›‘æ§é¢æ¿
            </a>
          </li>
          <li>
            <a href="/api-docs" target="_blank" class="external-link">
              <span class="link-type get">ğŸ“–</span>
              APIæ–‡æ¡£ (Swagger UI)
            </a>
          </li>
          <li>
            <a href="/swagger.json" target="_blank" class="external-link">
              <span class="link-type get">ğŸ“„</span>
              OpenAPIè§„èŒƒ (JSON)
            </a>
          </li>
        </ul>

        <div class="quick-actions">
          <a href="/api/health" class="btn btn-secondary">ç³»ç»Ÿå¥åº·æ£€æŸ¥</a>
          <a href="/api/performance" class="btn btn-secondary">æ€§èƒ½æŒ‡æ ‡</a>
          <button onclick="refreshStatus()" class="btn btn-primary">
            åˆ·æ–°çŠ¶æ€
          </button>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“¡ CPEç®¡ç†API</h2>
        <ul class="link-list">
          <li>
            <a href="/api/cpes" target="_blank">
              <span class="link-type get">GET</span>
              è·å–æ‰€æœ‰CPEåˆ—è¡¨
            </a>
          </li>
          <li>
            <a href="/api/cpes?status=online" target="_blank">
              <span class="link-type get">GET</span>
              è·å–åœ¨çº¿CPE
            </a>
          </li>
          <li>
            <a href="/api/cpes?status=offline" target="_blank">
              <span class="link-type get">GET</span>
              è·å–ç¦»çº¿CPE
            </a>
          </li>
          <li>
            <a href="#" onclick="showWakeupDialog()">
              <span class="link-type post">POST</span>
              å”¤é†’CPE (éœ€è¦CPE ID)
            </a>
          </li>
          <li>
            <a href="#" onclick="showConfigDialog()">
              <span class="link-type post">POST</span>
              ä¸‹å‘é…ç½® (éœ€è¦CPE ID)
            </a>
          </li>
        </ul>

        <div class="quick-actions">
          <a href="/api/cpes/stats" class="btn btn-secondary">CPEç»Ÿè®¡</a>
          <button onclick="scanRoutes()" class="btn btn-secondary">
            æ‰«æAPI
          </button>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ”Œ è®¾å¤‡ç®¡ç†API</h2>
        <ul class="link-list">
          <li>
            <a href="/api/devices" target="_blank">
              <span class="link-type get">GET</span>
              è·å–è®¾å¤‡åˆ—è¡¨
            </a>
          </li>
          <li>
            <a href="/api/devices/stats" target="_blank">
              <span class="link-type get">GET</span>
              è®¾å¤‡ç»Ÿè®¡ä¿¡æ¯
            </a>
          </li>
          <li>
            <a href="/api/devices/search" target="_blank">
              <span class="link-type get">GET</span>
              æœç´¢è®¾å¤‡
            </a>
          </li>
          <li>
            <a href="#" onclick="showCreateDeviceDialog()">
              <span class="link-type post">POST</span>
              åˆ›å»ºè®¾å¤‡
            </a>
          </li>
        </ul>

        <div class="quick-actions">
          <a href="/api/devices?status=online" class="btn btn-secondary"
            >åœ¨çº¿è®¾å¤‡</a
          >
          <a href="/api/devices?status=offline" class="btn btn-secondary"
            >ç¦»çº¿è®¾å¤‡</a
          >
        </div>
      </div>

      <div class="card">
        <h2>âš™ï¸ ç³»ç»ŸAPI</h2>
        <ul class="link-list">
          <li>
            <a href="/api" target="_blank">
              <span class="link-type get">GET</span>
              APIæ ¹ç›®å½•
            </a>
          </li>
          <li>
            <a href="/api/health" target="_blank">
              <span class="link-type get">GET</span>
              å¥åº·æ£€æŸ¥
            </a>
          </li>
          <li>
            <a href="/api/status" target="_blank">
              <span class="link-type get">GET</span>
              åº”ç”¨çŠ¶æ€
            </a>
          </li>
          <li>
            <a href="/api/echo/test-message" target="_blank">
              <span class="link-type get">GET</span>
              æ¶ˆæ¯å›æ˜¾
            </a>
          </li>
          <li>
            <a href="/api/performance" target="_blank">
              <span class="link-type get">GET</span>
              æ€§èƒ½æŒ‡æ ‡
            </a>
          </li>
          <li>
            <a href="/api/performance/health" target="_blank">
              <span class="link-type get">GET</span>
              è¯¦ç»†å¥åº·æ£€æŸ¥
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="card" style="grid-column: 1 / -1; margin-top: 20px">
      <h2>ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
      <div class="system-info">
        <div class="info-item">
          <div class="info-label">æœåŠ¡å™¨åœ°å€</div>
          <div>http://localhost:3000</div>
        </div>
        <div class="info-item">
          <div class="info-label">WebSocketåœ°å€</div>
          <div>ws://localhost:7547</div>
        </div>
        <div class="info-item">
          <div class="info-label">UDPå”¤é†’ç«¯å£</div>
          <div>7548</div>
        </div>
        <div class="info-item">
          <div class="info-label">ç¯å¢ƒæ¨¡å¼</div>
          <div id="env-mode">æ£€æµ‹ä¸­...</div>
        </div>
        <div class="info-item">
          <div class="info-label">å¯åŠ¨æ—¶é—´</div>
          <div id="uptime">--</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>Â© 2023 Koa Template App - ACSä»¿çœŸç³»ç»Ÿ v2.0</p>
      <p>
        Node.js <span id="node-version"></span> | æœ€åæ›´æ–°:
        <span id="last-update"></span>
      </p>
    </div>

    <!-- ç®€å•å¯¹è¯æ¡† -->
    <div
      id="dialog"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      "
    >
      <div
        style="
          background: white;
          width: 400px;
          margin: 100px auto;
          padding: 20px;
          border-radius: 8px;
        "
      >
        <h3 id="dialog-title"></h3>
        <input
          type="text"
          id="dialog-input"
          style="width: 100%; padding: 8px; margin: 10px 0"
          placeholder="è¾“å…¥CPE ID"
        />
        <div style="text-align: right">
          <button
            onclick="closeDialog()"
            style="padding: 8px 16px; margin-right: 10px"
          >
            å–æ¶ˆ
          </button>
          <button
            onclick="submitDialog()"
            style="
              padding: 8px 16px;
              background: #1890ff;
              color: white;
              border: none;
            "
          >
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>

    <script>
      // åˆå§‹åŒ–é¡µé¢
      document.addEventListener('DOMContentLoaded', function () {
        // è®¾ç½®ç‰ˆæœ¬ä¿¡æ¯
        document.getElementById('node-version').textContent =
          process?.versions?.node || 'æœªçŸ¥';
        document.getElementById('last-update').textContent =
          new Date().toLocaleDateString();

        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        loadSystemStatus();

        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡çŠ¶æ€
        setInterval(loadSystemStatus, 30000);
      });

      // åŠ è½½ç³»ç»ŸçŠ¶æ€
      async function loadSystemStatus() {
        try {
          // è·å–ç³»ç»Ÿå¥åº·ä¿¡æ¯
          const healthRes = await fetch('/api/health');
          if (healthRes.ok) {
            const healthData = await healthRes.json();
            document.getElementById('env-mode').textContent =
              healthData.environment || 'development';
            document.getElementById('uptime').textContent = formatUptime(
              healthData.uptime,
            );
          }

          // è·å–CPEç»Ÿè®¡ - ä¿®å¤è¿™éƒ¨åˆ†
          const cpeRes = await fetch('/api/cpes/stats');
          if (cpeRes.ok) {
            const result = await cpeRes.json();

            // æ£€æŸ¥APIè¿”å›çš„æ•°æ®ç»“æ„
            console.log('CPEç»Ÿè®¡å“åº”:', result);

            if (result.success && result.data) {
              const data = result.data;
              document.getElementById('total-devices').textContent =
                data.total || 0;
              document.getElementById('online-devices').textContent =
                data.online || 0;
              document.getElementById('offline-devices').textContent =
                data.offline || 0;
              document.getElementById('heartbeat-count').textContent =
                data.totalHeartbeats || 0;
            } else {
              // console.error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯:', result);
            }
          } else {
            // console.error('è·å–CPEç»Ÿè®¡å¤±è´¥:', cpeRes.status);
          }

          // è·å–WebSocketè¿æ¥æ•°
          const wsRes = await fetch('/api/performance/health');
          if (wsRes.ok) {
            const wsData = await wsRes.json();
            // è¿™é‡Œå¯ä»¥æ·»åŠ WebSocketè¿æ¥æ•°æ˜¾ç¤º
          }
        } catch (error) {
          console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', error);
        }
      }

      // æ ¼å¼åŒ–è¿è¡Œæ—¶é—´
      function formatUptime(seconds) {
        if (!seconds) return '--';
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return `${hours}h ${minutes}m ${secs}s`;
      }

      // å¯¹è¯æ¡†ç›¸å…³
      let currentDialogAction = null;
      let dialogInput = null;

      function showWakeupDialog() {
        document.getElementById('dialog-title').textContent = 'å”¤é†’CPE';
        document.getElementById('dialog-input').placeholder =
          'è¾“å…¥è¦å”¤é†’çš„CPE ID (ä¾‹å¦‚: cpe-001)';
        dialogInput = document.getElementById('dialog-input');
        dialogInput.value = '';
        currentDialogAction = 'wakeup';
        document.getElementById('dialog').style.display = 'block';
      }

      function showConfigDialog() {
        document.getElementById('dialog-title').textContent = 'ä¸‹å‘é…ç½®åˆ°CPE';
        document.getElementById('dialog-input').placeholder =
          'è¾“å…¥ç›®æ ‡CPE ID (ä¾‹å¦‚: cpe-001)';
        dialogInput = document.getElementById('dialog-input');
        dialogInput.value = '';
        currentDialogAction = 'config';
        document.getElementById('dialog').style.display = 'block';
      }

      function showCreateDeviceDialog() {
        document.getElementById('dialog-title').textContent = 'åˆ›å»ºè®¾å¤‡';
        document.getElementById('dialog-input').placeholder =
          'è¾“å…¥è®¾å¤‡ID (ä¾‹å¦‚: device-001)';
        dialogInput = document.getElementById('dialog-input');
        dialogInput.value = '';
        currentDialogAction = 'createDevice';
        document.getElementById('dialog').style.display = 'block';
      }

      function closeDialog() {
        document.getElementById('dialog').style.display = 'none';
        currentDialogAction = null;
      }

      async function submitDialog() {
        const value = dialogInput.value.trim();
        if (!value) {
          alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ID');
          return;
        }

        try {
          if (currentDialogAction === 'wakeup') {
            const response = await fetch(`/api/cpes/${value}/wakeup`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
            });

            if (response.ok) {
              alert(`å”¤é†’æŒ‡ä»¤å·²å‘é€åˆ° ${value}`);
            } else {
              alert(`å”¤é†’å¤±è´¥: ${await response.text()}`);
            }
          } else if (currentDialogAction === 'config') {
            // è¿™é‡Œå¯ä»¥æ‰©å±•ä¸ºæ›´å¤æ‚çš„é…ç½®ç•Œé¢
            const config = {
              timestamp: new Date().toISOString(),
              action: 'update',
              parameters: {
                'InternetGatewayDevice.ManagementServer.PeriodicInformInterval': 3600,
              },
            };

            const response = await fetch(`/api/cpes/${value}/configuration`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(config),
            });

            if (response.ok) {
              alert(`é…ç½®å·²ä¸‹å‘åˆ° ${value}`);
            } else {
              alert(`é…ç½®ä¸‹å‘å¤±è´¥: ${await response.text()}`);
            }
          } else if (currentDialogAction === 'createDevice') {
            const device = {
              deviceId: value,
              manufacturer: 'Generic',
              model: 'Device v1.0',
              ipAddress: '192.168.1.100',
              status: 'offline',
            };

            const response = await fetch('/api/devices', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(device),
            });

            if (response.ok) {
              alert(`è®¾å¤‡ ${value} åˆ›å»ºæˆåŠŸ`);
            } else {
              alert(`åˆ›å»ºè®¾å¤‡å¤±è´¥: ${await response.text()}`);
            }
          }
        } catch (error) {
          alert(`æ“ä½œå¤±è´¥: ${error.message}`);
        }

        closeDialog();
      }

      // åˆ·æ–°çŠ¶æ€
      function refreshStatus() {
        loadSystemStatus();
        alert('çŠ¶æ€å·²åˆ·æ–°');
      }

      // æ‰«æAPIè·¯ç”±ï¼ˆç®€å•ç‰ˆæœ¬ï¼‰
      async function scanRoutes() {
        const routes = [
          '/api',
          '/api/health',
          '/api/status',
          '/api/echo/test',
          '/api/devices',
          '/api/cpes',
          '/api/performance',
        ];

        let availableRoutes = [];

        for (const route of routes) {
          try {
            const response = await fetch(route);
            if (response.ok) {
              availableRoutes.push(`${route} âœ“`);
            }
          } catch (error) {
            availableRoutes.push(`${route} âœ—`);
          }
        }

        alert('APIè·¯ç”±æ‰«æå®Œæˆ:\n\n' + availableRoutes.join('\n'));
      }
    </script>
  </body>
</html>
