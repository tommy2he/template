import Koa from 'koa';
import bodyParser from 'koa-bodyparser';
import serve from 'koa-static';
import logger from './logger';
import errorHandler from './errorHandler';
import cors from './cors';
import config from '../config';

// 1.4版本新增性能监控中间件
import { performanceMonitor } from './performance';

// 1.3版本新增中间件
import compression from './compression';
import security from './security';
import rateLimit from './rateLimit';
import { swaggerUI } from './swagger'; // 只导入 swaggerUI

export default (app: Koa): void => {
  // ========== 1. 性能监控（最外层，测量完整请求时间） ==========
  if (config.env !== 'test') {
    app.use(performanceMonitor());
  }

  // ========== 2. 错误处理 ==========
  app.use(errorHandler());

  // ========== 3. CORS ==========
  app.use(cors());

  // ========== 4. 安全头（1.3版本新增） ==========
  if (config.security.enabled && config.env !== 'test') {
    app.use(security());
  }

  // ========== 5. 日志 ==========
  app.use(logger());

  // ========== 6. 请求体解析 ==========
  app.use(
    bodyParser({
      enableTypes: ['json', 'form', 'text'],
      jsonLimit: config.env === 'production' ? '1mb' : '10mb', // 生产环境限制更严格
      formLimit: config.env === 'production' ? '1mb' : '10mb',
      textLimit: config.env === 'production' ? '1mb' : '10mb',
    }),
  );

  // ========== 7. 压缩中间件（1.3版本新增） ==========
  if (config.compression.enabled) {
    app.use(compression());
  }

  // ========== 8. 速率限制（1.3版本新增） ==========
  if (config.rateLimit.enabled && config.env === 'production') {
    app.use(rateLimit());
  }

  // ========== 9. Swagger UI（1.3版本新增） ==========
  if (config.enableSwagger && config.env !== 'production') {
    app.use(swaggerUI());
  }

  // ========== 10. 静态文件服务 ==========
  app.use(
    serve('public', {
      maxage: config.env === 'production' ? 86400000 : 0, // 生产环境缓存1天
      hidden: false,
      index: 'index.html',
      defer: true, // 让Koa先处理其他中间件
    }),
  );

  console.log(`✅ 中间件加载完成（共${app.middleware.length}个）`);
};

// 导出所有中间件，方便单独使用
export * from './logger';
export * from './errorHandler';
export * from './cors';
export * from './compression';
export * from './security';
export * from './rateLimit';
export * from './swagger';
